services:
  mc-evolution:
    image: itzg/minecraft-server:java21
    container_name: mc-evolution-16gb
    restart: unless-stopped
    stop_grace_period: 1m30s

    ports:
      - "25565:25565"

    environment:
      EULA: "TRUE"
      TYPE: "ARCLIGHT"
      ARCLIGHT_TYPE: "${ARCLIGHT_TYPE:-FORGE}"
      VERSION: "${MC_VERSION:-1.20.1}"

      INIT_MEMORY: "${MC_INIT_MEMORY:-8G}"
      MAX_MEMORY: "${MC_MAX_MEMORY:-12G}"
      TZ: "${SERVER_TZ:-America/Lima}"

      USE_MEOWICE_FLAGS: "true"

      VIEW_DISTANCE: "8"
      SIMULATION_DISTANCE: "6"
      MAX_PLAYERS: "${MC_MAX_PLAYERS:-20}"
      SYNC_CHUNK_WRITES: "false"
      NETWORK_COMPRESSION_THRESHOLD: "256"
      ENABLE_COMMAND_BLOCK: "false"

      ENABLE_RCON: "true"
      RCON_PASSWORD: "${RCON_PASSWORD:?Set RCON_PASSWORD in .env}"

      USES_PLUGINS: "true"
      COPY_CONFIG_DEST: "/data/plugins"
      REMOVE_OLD_MODS: "true"
      REMOVE_OLD_MODS_INCLUDE: "*.jar"
      REMOVE_OLD_MODS_DEPTH: "2"

      # ProtocolLib, PlaceholderAPI, LuckPerms, TAB, Chunky
      SPIGET_RESOURCES: "1997,6245,28140,57806,81534"

      RCON_CMDS_STARTUP: |-
        chunky world world
        chunky shape circle
        chunky center 0 0
        chunky radius ${CHUNKY_RADIUS_OVERWORLD:-40000}
        chunky start
        chunky world world_nether
        chunky shape circle
        chunky center 0 0
        chunky radius ${CHUNKY_RADIUS_NETHER:-24000}
        chunky start
        chunky world world_the_end
        chunky shape circle
        chunky center 0 0
        chunky radius ${CHUNKY_RADIUS_END:-18000}
        chunky start
        chunky quiet 15
        chunky progress

      RCON_CMDS_FIRST_CONNECT: |-
        chunky pause

      RCON_CMDS_LAST_DISCONNECT: |-
        chunky continue

    volumes:
      - ./data:/data
      - ./mods:/mods:ro
      - ./plugin:/plugins:ro
      - ./plugin/config:/config:ro

    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/127.0.0.1/25565'"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 2m

  mc-backup:
    image: "${MC_BACKUP_IMAGE:-itzg/mc-backup:2026.2.0@sha256:ba5cf40c25973aad937bece38747e05ef99215a15a5aecf55a4ed9e8aa5e2668}"
    container_name: mc-evolution-backup
    restart: unless-stopped
    depends_on:
      - mc-evolution
    environment:
      RCON_HOST: "mc-evolution"
      RCON_PORT: "25575"
      RCON_PASSWORD: "${RCON_PASSWORD:?Set RCON_PASSWORD in .env}"
      INITIAL_DELAY: "2m"
      BACKUP_INTERVAL: "24h"
      PRUNE_BACKUPS_DAYS: "7"
      PAUSE_IF_NO_PLAYERS: "true"
    volumes:
      - ./data:/data:ro
      - ./backups:/backups
